
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebTransport Test</title>
  </head>
  <body>
    <script type="module">
      async function main() {
        try {
          // STEP 1 — get server certificate hash
          const res = await fetch('http://0.0.0.0:8000/');
          const hashHex = (await res.text()).trim();

          // Helper to convert hex string to Uint8Array
          const hexToUint8 = (hex) =>
            new Uint8Array(
              hex.match(/.{1,2}/g).map((byte) => parseInt(byte, 16))
            );

          const hash = hexToUint8(hashHex);

          // STEP 2 — connect to WebTransport server
          const transport = new WebTransport("https://0.0.0.0:4443", {
            serverCertificateHashes: [{ algorithm: "sha-256", value: hash }],
          });

          // Wait for connection
          await transport.ready;
          console.log("✅ WebTransport connected");

          // STEP 3 — open a bidirectional stream
          const stream = await transport.createBidirectionalStream();
          const writer = stream.writable.getWriter();
          const reader = stream.readable.getReader();

          // Send a message
          const msg = "Hello from client";
          await writer.write(new TextEncoder().encode(msg));
          await writer.close();
          console.log("📤 Sent:", msg);

          // Read the reply
          const { value, done } = await reader.read();
          if (!done && value) {
            const reply = new TextDecoder().decode(value);
            console.log("📥 Received:", reply);
          }

          // STEP 4 — close gracefully
          await transport.close();
          console.log("🔚 Connection closed");

        } catch (err) {
          console.error("❌ Error:", err);
        }
      }

      main();
    </script>
  </body>
</html>
